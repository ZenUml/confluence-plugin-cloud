<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114996686-1"></script>
  <script type="text/javascript" src="js/google-analytics.js"></script>
  <meta charset="UTF-8">
  <title>ZenUML Graph Macro Migrator</title>
  <script type="text/javascript" src="https://connect-cdn.atl-paas.net/all.js"></script>
  <script type="text/javascript" src="./js/util.js"></script>
  <script type="text/javascript">
    async function execute() {
      try {
        const pageId = getUrlParam('pageId');
        if(pageId === '') {
          console.debug('Not on a page. Skipping upgrading...')
          AP.getLocation(function(location){
            console.debug('Page location:', location);
            gtag('event', 'skip', {'event_category' : 'Macro',  'event_label' : location});
          });
          return;
        }
        const descriptorVersion = getUrlParam('version');
        if(descriptorVersion !== '2021.4.1') {
          console.debug('This confluence instance has not been updated. Skipping upgrading...')
          gtag('event', 'skip', {'event_category' : 'Macro',  'event_label' : pageId});
          return;
        }
        const pageContent = await AP.request({url: `/rest/api/content/${pageId}/?expand=body.storage,version`, type: 'GET'});
        let parsedPage = JSON.parse(pageContent.body);
        const storageFormatContent = parsedPage.body.storage.value;
        const version = parsedPage.version.number;
        const title = parsedPage.title;
        console.debug('title:', title);
        console.debug('version:', version);

        if(storageFormatContent.indexOf('ac:name="zenuml-graph-macro"') >= 0) {
          AP.flag.create({
            title: 'ZenUML Graph Macro Upgrading',
            type: 'info',
          });

          gtag('event', 'detect', {'event_category' : 'Macro',  'event_label' : pageId});
          const converted = storageFormatContent.replace(/ac:name="zenuml-graph-macro"/g, 'ac:name="zenuml-graph-macro-lite"');
          const putBody = {
            id: pageId,
            type: "page",
            title: title,
            body: {
              storage: {
                value: converted,
                representation: "storage"
              }
            },
            version: {
              number: version + 1
            }
          };
          const response = await AP.request({
            url: `/rest/api/content/${pageId}/`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(putBody)
          });
          gtag('event', 'migrate', {'event_category' : 'Macro',  'event_label' : pageId});
          console.debug('response:', response);
          await AP.navigator.reload();
          console.debug('ZenUML Graph Macro upgraded successfully.');
        }
      } catch (e) {
        if(e.err.indexOf('"statusCode":404') !== -1) {
          console.warn('Received 404 error. Most likely the user is creating a page.')
          gtag('event', '404', {'event_category' : 'Macro',  'event_label' : e.err.substring(0, 100)});
        } else {
          console.error("Failed to detect graph macro. Please contact us at https://www.zenuml.com.", e);
          gtag('event', 'error', {'event_category' : 'Macro',  'event_label' : e.err.substring(0, 100)});
        }
        AP.getLocation(function(location){
          console.debug('Page location:', location);
          gtag('event', 'error', {'event_category' : 'Macro',  'event_label' : location});
        });
      }
    }
    execute();
  </script>

</head>
<body>

</body>
</html>