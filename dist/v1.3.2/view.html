<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script type="text/javascript" src="js/google-analytics.js"></script>
  <title>confluence-plugin-view</title>

  <meta charset="utf-8">
  <script type="text/javascript" src="js/util.js"></script>
  <script type="text/javascript" src="js/dom-to-image.min.js"></script>
  <script type="text/javascript" src="js/md5.js"></script>

  <script id="connect-loader">

    function toPng() {
        var node = document.getElementsByClassName('sequence-diagram')[0];
        return domtoimage.toBlob(node, { bgcolor: 'white' });
    }

    async function getAttachments(pageId) {
      var attachments;
      const response = await AP.request({
        url: '/rest/api/content/' + pageId + '/child/attachment?expand=version',
        type: 'GET'
      });
      attachments = JSON.parse(response.body).results;
      return attachments;
    }

    async function uploadAttachment(attachmentName, uri, hash) {
      const blob = await toPng();
      const file = new File([blob], attachmentName, {type: 'image/png'});

      const response = await AP.request({
        url: uri,
        type: 'POST',
        contentType: 'multipart/form-data',
        data: {minorEdit: true, comment: hash, file: file}
      });
      return response;
    }

    async function updateAttachmentProperties(pageId, attachmentId, versionNumber, hash) {
      await AP.request({
        url: '/rest/api/content/' + pageId + '/child/attachment/' + attachmentId,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({minorEdit: true, id: attachmentId, type: 'attachment', version: {number: versionNumber}, metadata: {comment: hash}})
      });
    }

    async function createAttachmentIfContentChanged(content) {
      const hash = md5(content);

      const pageId = getUrlParam("pageId");
      const attachments = await getAttachments(pageId);

      const attachmentName = 'zenuml-' + getUrlParam("uuid") + '.png';
      var attachment = attachments.find(a => a.title === attachmentName);

      const uri = attachment != null
        ? '/rest/api/content/' + pageId + '/child/attachment/' + attachment.id + '/data'
        : '/rest/api/content/' + pageId + '/child/attachment';

      if(attachment == null || hash !== attachment.metadata.comment) {
        const response = await uploadAttachment(attachmentName, uri, hash);

        const attachmentId = attachment != null ? attachment.id : JSON.parse(response.body).results[0].id;
        const versionNumber = attachment != null ? attachment.version.number + 1 : 1;

        await updateAttachmentProperties(pageId, attachmentId, versionNumber, hash);
      }
    }

    async function onMacroBodyReady(body) {
      store.commit('code', body);
      setTimeout(function () {
        let width = document.body.scrollWidth;
        let height = document.body.scrollHeight;
        console.log('Resize to ', width, height);
        AP.resize(width, height);
      }, 1000);
      await createAttachmentIfContentChanged(body);
    }

    async function initializeMacro() {
      const macro = new Macro(AP.confluence);
      const code = (await macro.load()).code
      await onMacroBodyReady(code)
    }

    function loadConnect() {
      JavaScript.load(getConnectUrl(), initializeMacro);
    }
    window.onAppLoaded = loadConnect;

  </script>

  <link href="css/diagram_lite.css" rel="stylesheet">
<link href="/v1.3.2/css/chunk-vendors.33cd507d.css" rel="stylesheet"><link href="/v1.3.2/css/app.1661f0c7.css" rel="stylesheet"></head>
<body>
<div id="workspace" class="container view">
  <div id="app"></div>
</div>
<!-- built files will be auto injected -->
<script type="text/javascript" src="/v1.3.2/js/chunk-vendors.be34c80f.js"></script><script type="text/javascript" src="/v1.3.2/js/app.a507bf53.js"></script></body>
</html>
